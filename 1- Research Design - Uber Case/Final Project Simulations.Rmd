---
title: "Final Project"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# {.tabset}

## Part 2


```{r Libraries}
library(data.table)
library(DT)
library(pwr)
```


## Result assumption
In our study, the significant difference in star ratings for the treatment (discount receivers) and control (standard price receivers) group will be 3.5 and 3 respectively. Based on this assumption, the 95% confidence interval will be [2, 5] for the coupon users and the [1.5, 4.5] for non-coupon users.

# Standard deviation
We calculated the standard deviation based on the below:
The 95% confidence interval bond and mean: 1.5
The n of standard deviation away from the mean to the bond: 1.96
```{r}
std<-1.5/1.96
print(sd)
```

# The effect size
Based on the standard deviation calculated above: std = 0.7653061, we were able to calculate the effect size:
```{r}
d<-(3.5-3)/std
print(d)
```
## Same sample size for both groups (power>=0.9)
We started our simulations based on the effect size calculated above (d=0.653), to calculate the sample size of both the treatment and the control group. We want the sample size to be similar for both.

```{r}
pwr.t.test(n=NULL,d=d,sig.level = 0.05,power=0.9,alternative = "greater")
```
With a sample size of 41 for each the treatment and the control group, we can ensure a power of 0.9, an effect size of 0.653 with a significance leve of 0.05.

## Simulation Scenario I: No Effect
In order to be able to proceed with the simulation of a sample size of 82 divided equally into the treatment and control group, we randomized our sample using the assumptions calculated previously:

  n1=41

  n2=41
  
  mean = 3.5

  std=0.7653061
  
  d=0.653

  sig.level = 0.05

```{r}
set.seed(seed = 329)

rating.dat <- data.table(Group = c(rep.int(x = "Treatment", times = 41), rep.int(x = "Control", times = 41)))

rating.dat[Group == "Control", rating := round(x = rnorm(n = .N, mean = 3.5, sd = std), digits = 1)]
rating.dat[Group == "Treatment", rating := round(x = rnorm(n = .N, mean = 3.5, sd = std), digits = 1)]
datatable(data = rating.dat)

``` 
We will then perform a one sided two sample t-test to further understand the relationship between the star ratings and the price variation.

The results show that whether applying a discount on the price or not does not affect the star ratings of the uber driver. This is shown by the p-value = 0.2601 which is greater than the significance level (0.05). We will not reject our null hypothesis. We can also notice that their is a very minimal difference between the means of both groups:

  - Mean Treatment group = 3.549
  - Mean Control group = 3.446

```{r}
t.test(rating.dat[rating.dat$Group=="Treatment",]$rating, rating.dat[rating.dat$Group=="Control",]$rating,alternative = "greater")
``` 
*Conclusion:*

The results of this simulation highlights that applying a discount on the rides' price will not affect the star rating. This would push us to perform further research and account for other variables such as the timing of the ride, the location, the weather and so on. In this case, an informative questionnaire might improve our choice of the dependent variable.

## Simulation Scenario II: An Expected Effect
In order to be able to proceed with the simulation of a sample size of 82 divided equally into the treatment and control group, we again, randomized our sample using the assumptions calculated previously:

  n1=41 with mean = 3

  n2=41 mean = 3.5
  
  std=0.7653061
  
  d=0.653

  sig.level = 0.05

```{r}
set.seed(seed = 329)

rating.dat <- data.table(Group = c(rep.int(x = "Treatment", times = 41), rep.int(x = "Control", times = 41)))

rating.dat[Group == "Control", rating := round(x = rnorm(n = .N, mean = 3, sd = std), digits = 1)]
rating.dat[Group == "Treatment", rating := round(x = rnorm(n = .N, mean = 3.5, sd = std), digits = 1)]
datatable(data = rating.dat)
```

We will then perform a one sided two sample t-test to further understand the relationship between the star ratings and the price variation.

The results show that applying a discount on the price increases the star ratings of the uber driver. This is shown by the p-value = 0.0001427 which is greater than the significance level (0.05). We can then reject the null hypothesis that states that there is no effect between the pricing and the star rating. We can also notice that their is a significant difference between the means of both groups:

  - Mean Treatment group = 3.548780  
  - Mean Control group = 2.946341 
  
```{r}
t.test(rating.dat[rating.dat$Group=="Treatment",]$rating,rating.dat[rating.dat$Group=="Control",]$rating,alternative = "greater")
```  
  
*Conclusion:*

The results of this simulation highlights that applying a discount on the rides' price will affect the star rating. This will allow us to look into our pricing algorithm and leverage our predictions in order to enhance our services. 
  
  
## Same sample size for both groups (power>=0.95)
We will now change our power value in order to enhance our research. The power value would become power = 0.95.

Using the same effect size previously calculated, d = 0.653, we now calculate our sample size:

```{r}
pwr.t.test(n=NULL,d=d,sig.level = 0.05,power=0.95,alternative = "greater")
```
To be able to perform the analysis with all of the above characteristics we will need a sample size of at least 104 divided equally to both groups.

## Simulation Scenario I: No effect
Following the same steps as above, we randomized a sample with the following characteristics:

  n1=52

  n2=52

  mean = 3.5

  std=0.7653061

  d=0.653

  sig.level = 0.05
```{r}
set.seed(seed = 329)

rating.dat <- data.table(Group = c(rep.int(x = "Treatment", times = 52), rep.int(x = "Control", times = 52)))

rating.dat[Group == "Control", rating := round(x = rnorm(n = .N, mean = 3.5, sd = std), digits = 1)]
rating.dat[Group == "Treatment", rating := round(x = rnorm(n = .N, mean = 3.5, sd = std), digits = 1)]
datatable(data = rating.dat)
```

The one sided two sample t-test states that there is no effect between the price variation and the star ratings. This conclusion was reached to by looking at the p-value = 0.7509 > 0.05 (Sig. level). 

The results show that whether applying a discount on the price or not does not affect the star ratings of the Uber driver. This is shown by the p-value = 0.2601 which is greater than the significance level (0.05). We can also notice that their is a very minimal difference between the means of both groups: 

  - Mean Treatment group = 3.442308 
  - Mean Control group = 3.536538

```{r}
t.test(rating.dat[rating.dat$Group=="Treatment",]$rating,rating.dat[rating.dat$Group=="Control",]$rating,alternative = "greater")
```
## Simulation Scenario II: An Expected Effect

```{r}
set.seed(seed = 329)

rating.dat <- data.table(Group = c(rep.int(x = "Treatment", times = 52), rep.int(x = "Control", times = 52)))

rating.dat[Group == "Control", rating := round(x = rnorm(n = .N, mean = 3, sd = std), digits = 1)]
rating.dat[Group == "Treatment", rating := round(x = rnorm(n = .N, mean = 3.5, sd = std), digits = 1)]
datatable(data = rating.dat)
t.test(rating.dat[rating.dat$Group=="Treatment",]$rating,rating.dat[rating.dat$Group=="Control",]$rating,alternative = "greater")
```
## Same sample size for both groups (power>=0.99)
Now, we have the effect size based on the assumption to be 0.653. We firstly want to simulate a dataset with treatment group and control group to have same size. 
```{r}
pwr.t.test(n=NULL,d=d,sig.level = 0.05,power=0.99,alternative = "greater")
```
## Simulation Scenario I: No Effect
Scenario I
```{r}
set.seed(seed = 329)

rating.dat <- data.table(Group = c(rep.int(x = "Treatment", times = 75), rep.int(x = "Control", times = 75)))

rating.dat[Group == "Control", rating := round(x = rnorm(n = .N, mean = 3.5, sd = std), digits = 1)]
rating.dat[Group == "Treatment", rating := round(x = rnorm(n = .N, mean = 3.5, sd = std), digits = 1)]
datatable(data = rating.dat)
t.test(rating.dat[rating.dat$Group=="Treatment",]$rating,rating.dat[rating.dat$Group=="Control",]$rating,alternative = "greater")
```
## Simulation Scenario II: An Expected Effect
Scenario II
```{r}
set.seed(seed = 329)

rating.dat <- data.table(Group = c(rep.int(x = "Treatment", times = 75), rep.int(x = "Control", times = 75)))

rating.dat[Group == "Control", rating := round(x = rnorm(n = .N, mean = 3, sd = std), digits = 1)]
rating.dat[Group == "Treatment", rating := round(x = rnorm(n = .N, mean = 3.5, sd = std), digits = 1)]
datatable(data = rating.dat)
t.test(rating.dat[rating.dat$Group=="Treatment",]$rating,rating.dat[rating.dat$Group=="Control",]$rating,alternative = "greater")
```
## Unequal sample size for both groups (power>=0.9)
Considering the budget, we would like to decrease the coupon group. However, we still want to keep the power at an effective level. Now, we have the effect size based on the assumption to be 0.653. We firstly want to simulate a dataset with a two unequal size groups. We would like to have a smaller size for coupon users. So, we set control group to a lager size. Here, we assume it to be 200.
```{r}
pwr.t2n.test(n1=NULL,n2=200,d=d,sig.level = 0.05,power=0.9,alternative = "greater")
```
## Simulation Scenario I: No Effect
Scenario I
```{r}
set.seed(seed = 329)

rating.dat <- data.table(Group = c(rep.int(x = "Treatment", times = 23), rep.int(x = "Control", times = 200)))

rating.dat[Group == "Control", rating := round(x = rnorm(n = .N, mean = 3.5, sd = std), digits = 1)]
rating.dat[Group == "Treatment", rating := round(x = rnorm(n = .N, mean = 3.5, sd = std), digits = 1)]
datatable(data = rating.dat)
t.test(rating.dat[rating.dat$Group=="Treatment",]$rating,rating.dat[rating.dat$Group=="Control",]$rating,alternative = "greater")
```
## Simulation Scenario II: An Expected Effect
Scenario II
```{r}
set.seed(seed = 329)

rating.dat <- data.table(Group = c(rep.int(x = "Treatment", times = 23), rep.int(x = "Control", times = 200)))

rating.dat[Group == "Control", rating := round(x = rnorm(n = .N, mean = 3, sd = std), digits = 1)]
rating.dat[Group == "Treatment", rating := round(x = rnorm(n = .N, mean = 3.5, sd = std), digits = 1)]
datatable(data = rating.dat)
t.test(rating.dat[rating.dat$Group=="Treatment",]$rating,rating.dat[rating.dat$Group=="Control",]$rating,alternative = "greater")
```
## Unequal sample size for both groups (power>=0.95)
Considering the budget, we would like to decrease the coupon group. However, we still want to keep the power at an effective level. Now, we have the effect size based on the assumption to be 0.653. We firstly want to simulate a dataset with a two unequal size groups. We would like to have a smaller size for coupon users. So, we set control group to a lager size. Here, we assume it to be 200.
```{r}
pwr.t2n.test(n1=NULL,n2=200,d=d,sig.level = 0.05,power=0.95,alternative = "greater")
```
## Simulation Scenario I: No Effect
Scenario I
```{r}
set.seed(seed = 329)

rating.dat <- data.table(Group = c(rep.int(x = "Treatment", times = 30), rep.int(x = "Control", times = 200)))

rating.dat[Group == "Control", rating := round(x = rnorm(n = .N, mean = 3.5, sd = std), digits = 1)]
rating.dat[Group == "Treatment", rating := round(x = rnorm(n = .N, mean = 3.5, sd = std), digits = 1)]
datatable(data = rating.dat)
t.test(rating.dat[rating.dat$Group=="Treatment",]$rating,rating.dat[rating.dat$Group=="Control",]$rating,alternative = "greater")
```
## Simulation Scenario II: An Expected Effect
Scenario II
```{r}
set.seed(seed = 329)

rating.dat <- data.table(Group = c(rep.int(x = "Treatment", times = 30), rep.int(x = "Control", times = 200)))

rating.dat[Group == "Control", rating := round(x = rnorm(n = .N, mean = 3, sd = std), digits = 1)]
rating.dat[Group == "Treatment", rating := round(x = rnorm(n = .N, mean = 3.5, sd = std), digits = 1)]
datatable(data = rating.dat)
t.test(rating.dat[rating.dat$Group=="Treatment",]$rating,rating.dat[rating.dat$Group=="Control",]$rating,alternative = "greater")
```
## Unequal sample size for both groups (power>=0.99)
Considering the budget, we would like to decrease the coupon group. However, we still want to keep the power at an effective level. Now, we have the effect size based on the assumption to be 0.653. We firstly want to simulate a dataset with a two unequal size groups. We would like to have a smaller size for coupon users. So, we set control group to a lager size. Here, we assume it to be 200.
```{r}
pwr.t2n.test(n1=NULL,n2=200,d=d,sig.level = 0.05,power=0.99,alternative = "greater")
```
## Simulation Scenario I: No Effect
Scenario I
```{r}
set.seed(seed = 329)

rating.dat <- data.table(Group = c(rep.int(x = "Treatment", times = 46), rep.int(x = "Control", times = 200)))

rating.dat[Group == "Control", rating := round(x = rnorm(n = .N, mean = 3.5, sd = std), digits = 1)]
rating.dat[Group == "Treatment", rating := round(x = rnorm(n = .N, mean = 3.5, sd = std), digits = 1)]
datatable(data = rating.dat)
t.test(rating.dat[rating.dat$Group=="Treatment",]$rating,rating.dat[rating.dat$Group=="Control",]$rating,alternative = "greater")
```
## Simulation Scenario II: An Expected Effect
Scenario II
```{r}
set.seed(seed = 329)

rating.dat <- data.table(Group = c(rep.int(x = "Treatment", times = 46), rep.int(x = "Control", times = 200)))

rating.dat[Group == "Control", rating := round(x = rnorm(n = .N, mean = 3, sd = std), digits = 1)]
rating.dat[Group == "Treatment", rating := round(x = rnorm(n = .N, mean = 3.5, sd = std), digits = 1)]
datatable(data = rating.dat)
t.test(rating.dat[rating.dat$Group=="Treatment",]$rating,rating.dat[rating.dat$Group=="Control",]$rating,alternative = "greater")
```
##Simulate many experiments
We decide to repeat the experiment with unequal size groups with 0.99 power under single experiment because it has smaller size of treatment groups, costing less budget and has a higher power as well.
Scenario I:
```{r}
B <- 1000
RNGversion(vstr = 3.6)
set.seed(seed = 4172)
Experiment <- 1:B
Group <- c(rep.int(x = "Treatment", times = 46), rep.int(x = "Control", times = 200))

sim.dat <- as.data.table(expand.grid(Experiment = Experiment, Group = Group))
setorderv(x = sim.dat, cols = c("Experiment", "Group"), order = c(1,1))
sim.dat[Group == "Control", rating := round(x = rnorm(n = .N, mean = 3.5, sd = std), digits = 1)]
sim.dat[Group == "Treatment", rating := round(x = rnorm(n = .N, mean = 3.5, sd = std), digits = 1)]
dim(sim.dat)
```
##Helper Function
```{r}
analyze.experiment <- function(the.dat) {
    require(data.table)
    setDT(the.dat)
    
    the.test <- t.test(x = the.dat[Group == "Treatment", 
        rating], y = the.dat[Group == "Control", rating], alternative = "greater")
    
    the.effect <- the.test$estimate[1] - the.test$estimate[2]
    lower.bound <- the.test$conf.int[1]
    p <- the.test$p.value
    
    result <- data.table(effect = the.effect, lower_ci = lower.bound, 
        p = p)
    
    return(result)
}
```
##Summary of the test results of 1000 experiments under scenario I
```{r}
exp.results <- sim.dat[, analyze.experiment(the.dat = .SD), 
    keyby = "Experiment"]

DT::datatable(data = round(x = exp.results[1:100, ], digits = 3), 
    rownames = F)
```
##Result of scenario I:
The true effect of the scenario I
A 95% confidence interval for the estimated effect from the simulated results.
Scenario 1: The percentage of false positives and true negatives.

```{r}
sce1_mean_effect<-round(exp.results[,mean(effect)],3)
sce1_lower_bonud_95_mean_effect<-round(exp.results[,mean(effect)]-1.96*exp.results[,sd(effect)],3)
sce1_upper_bonud_95_mean_effect<-round(exp.results[,mean(effect)]+1.96*exp.results[,sd(effect)],3)
sce1_percentage_of_false_positive<-exp.results[,mean(p<=0.05)]
sce1_percentage_of_true_negative<-exp.results[,mean(p>0.05)]

```
##Repeated experiments for scenario II
```{r}
B <- 1000
RNGversion(vstr = 3.6)
set.seed(seed = 4172)
Experiment <- 1:B
Group <- c(rep.int(x = "Treatment", times = 46), rep.int(x = "Control", times = 200))

sim.dat <- as.data.table(expand.grid(Experiment = Experiment, Group = Group))
setorderv(x = sim.dat, cols = c("Experiment", "Group"), order = c(1,1))
sim.dat[Group == "Control", rating := round(x = rnorm(n = .N, mean = 3, sd = std), digits = 1)]
sim.dat[Group == "Treatment", rating := round(x = rnorm(n = .N, mean = 3.5, sd = std), digits = 1)]
dim(sim.dat)
```
##Helper Function
```{r}
analyze.experiment <- function(the.dat) {
    require(data.table)
    setDT(the.dat)
    
    the.test <- t.test(x = the.dat[Group == "Treatment", 
        rating], y = the.dat[Group == "Control", rating], alternative = "greater")
    
    the.effect <- the.test$estimate[1] - the.test$estimate[2]
    lower.bound <- the.test$conf.int[1]
    p <- the.test$p.value
    
    result <- data.table(effect = the.effect, lower_ci = lower.bound, 
        p = p)
    
    return(result)
}
```
##Summary of the test results of 1000 experiments under scenario II
```{r}
exp.results <- sim.dat[, analyze.experiment(the.dat = .SD), 
    keyby = "Experiment"]
DT::datatable(data = round(x = exp.results[1:100, ], digits = 3), 
    rownames = F)
```
##Result of scenario II:
The true effect of the scenario II
A 95% confidence interval for the estimated effect from the simulated results.
Scenario 2: The percentage of false negatives and true positives.
```{r}
sce2_mean_effect<-round(exp.results[,mean(effect)],3)
sce2_lower_bonud_95_mean_effect<-round(exp.results[,mean(effect)]-1.96*exp.results[,sd(effect)],3)
sce2_upper_bonud_95_mean_effect<-round(exp.results[,mean(effect)]+1.96*exp.results[,sd(effect)],3)
sce2_percentage_of_false_negative<-exp.results[,mean(p>0.05)]
sce2_percentage_of_true_positive<-exp.results[,mean(p<=0.05)]
```

##Result table for research question:
```{r}
Result_Table<-data.table(Research_Question = c("Question 1","Question 1"),Scenario = c("No Effect","Effect: (People using coupons will give 0.5 greater for rating)"),Mean_Effec_in_Simulated_Data=c(sce1_mean_effect,sce2_mean_effect),NinetyFive_Percent_Confidence_Interval_of_Mean_Effect=c(paste("[",sce1_lower_bonud_95_mean_effect,",",sce1_upper_bonud_95_mean_effect,"]",sep = ""),paste("[",sce2_lower_bonud_95_mean_effect,",",sce2_upper_bonud_95_mean_effect,"]",sep = "")),Percentage_of_False_Positives=c(sce1_percentage_of_false_positive,"N/A"),Percentage_of_True_Negative=c(sce1_percentage_of_true_negative,"N/A"),Percentage_of_False_Negative=c("N/A",sce2_percentage_of_false_negative),Percentage_of_True_Positive=c("N/A",sce2_percentage_of_true_positive))
DT::datatable(Result_Table,options = list(
  autoWidth = TRUE),rownames = FALSE, colnames = c("Research Question","Scenario","Mean Effect","95% Conf.int of Effect","% of False Positive","% of True Negative","% of False Negative","% of True Positive"))
```